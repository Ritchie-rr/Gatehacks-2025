<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASL + Jitsi Live Captioning</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Jitsi iFrame API -->
    <script src="https://meet.jit.si/external_api.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #020617;
            color: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }

        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            height: 100vh;
        }

        #jitsi-container {
            position: relative;
            background: #000;
        }

        #meet {
            width: 100%;
            height: 100%;
        }

        /* Overlay for ASL prediction */
        #asl-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(15, 23, 42, 0.85);
            padding: 12px 18px;
            border-radius: 12px;
            z-index: 9999;
            min-width: 130px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        }

        #asl-overlay-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        #asl-letter {
            font-size: 40px;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #38bdf8, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        #asl-confidence {
            font-size: 12px;
            color: #e5e7eb;
            text-align: center;
            margin-top: 4px;
        }

        .confidence-bar {
            margin-top: 6px;
            background: #1f2937;
            border-radius: 999px;
            height: 6px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #22c55e, #facc15);
            transition: width 0.2s ease-out;
        }

        /* Right sidebar */
        .sidebar {
            background: #020617;
            border-left: 1px solid #111827;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: #020617;
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid #1f2937;
        }

        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        #word-display {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 4px;
            min-height: 40px;
        }

        #word-display.empty {
            font-size: 14px;
            letter-spacing: 0;
            font-style: italic;
            color: #6b7280;
        }

        .hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 6px;
        }

        .history-list {
            max-height: 220px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 6px 8px;
            border-radius: 8px;
            background: #020617;
            border: 1px solid #1f2937;
            margin-bottom: 4px;
        }

        .history-letter {
            font-weight: 600;
            color: #38bdf8;
            font-size: 18px;
        }

        .history-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .history-conf {
            font-size: 11px;
            color: #9ca3af;
        }

        .history-time {
            font-size: 11px;
            color: #4b5563;
        }

        .status-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 6px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4b5563;
        }

        .dot.ok {
            background: #22c55e;
        }

        .dot.err {
            background: #ef4444;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            flex: 1;
            padding: 7px 10px;
            border-radius: 8px;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
            font-size: 12px;
            cursor: pointer;
        }

        .btn:hover {
            background: #111827;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .sidebar {
                height: auto;
                max-height: 45vh;
            }
            #jitsi-container {
                height: 55vh;
            }
        }
    </style>
</head>
<body>
<div class="layout">
    <!-- LEFT: Jitsi + overlay -->
    <div id="jitsi-container">
        <div id="meet"></div>

        <div id="asl-overlay">
            <div id="asl-overlay-title">ASL Prediction</div>
            <div id="asl-letter">-</div>
            <div id="asl-confidence">0%</div>
            <div class="confidence-bar">
                <div class="confidence-fill" id="conf-fill"></div>
            </div>
        </div>

        <!-- Hidden local camera for ASL capture -->
        <video id="asl-cam" autoplay playsinline muted style="display:none;"></video>
        <canvas id="asl-canvas" style="display:none;"></canvas>
    </div>

    <!-- RIGHT: word, history, status -->
    <div class="sidebar">
        <div class="card">
            <h2>Current Word</h2>
            <div id="word-display" class="empty">(empty)</div>
            <div class="hint">
                BACKSPACE = delete last letter · ESC = clear word
            </div>
            <div class="btn-row">
                <button class="btn" id="btn-clear">Clear</button>
                <button class="btn" id="btn-copy">Copy</button>
            </div>
        </div>

        <div class="card">
            <h2>Recent Detections</h2>
            <div id="history-list" class="history-list">
                <div style="font-size:12px; color:#6b7280; text-align:center; padding:10px;">
                    No detections yet
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Status</h2>
            <div class="status-row">
                <div class="status-item">
                    <div class="dot" id="dot-camera"></div>
                    <span id="status-camera">Camera: Initializing...</span>
                </div>
                <div class="status-item">
                    <div class="dot" id="dot-ws"></div>
                    <span id="status-ws">Backend: Disconnected</span>
                </div>
                <div class="status-item">
                    <div class="dot" id="dot-model"></div>
                    <span id="status-model">Model: Unknown</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ---------- JITSI SETUP ----------
    function initJitsi() {
        const domain = "meet.jit.si";
        const options = {
            roomName: "ASLRoomDemo2025", // you can randomize this if you want
            width: "100%",
            height: "100%",
            parentNode: document.querySelector('#meet'),
            interfaceConfigOverwrite: {
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false
            }
        };
        // eslint-disable-next-line no-undef
        const api = new JitsiMeetExternalAPI(domain, options);
        return api;
    }

    // ---------- ASL + WS STATE ----------
    let ws = null;
    let word = "";
    let history = [];
    let lastPrediction = null;
    let sameCount = 0;
    const REQUIRED_SAME = 3; // require 3 consistent predictions before adding to word

    const aslCam = document.getElementById("asl-cam");
    const aslCanvas = document.getElementById("asl-canvas");
    const aslCtx = aslCanvas.getContext("2d");

    const letterEl = document.getElementById("asl-letter");
    const confTextEl = document.getElementById("asl-confidence");
    const confFillEl = document.getElementById("conf-fill");
    const wordEl = document.getElementById("word-display");
    const historyEl = document.getElementById("history-list");

    const dotCamera = document.getElementById("dot-camera");
    const dotWs = document.getElementById("dot-ws");
    const dotModel = document.getElementById("dot-model");
    const statusCamera = document.getElementById("status-camera");
    const statusWs = document.getElementById("status-ws");
    const statusModel = document.getElementById("status-model");

    // ---------- CAMERA ----------
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            aslCam.srcObject = stream;
            dotCamera.classList.add("ok");
            statusCamera.textContent = "Camera: OK";
        } catch (err) {
            console.error("Camera error:", err);
            dotCamera.classList.add("err");
            statusCamera.textContent = "Camera: Error / Denied";
        }
    }

    // ---------- WEBSOCKET ----------
    function getWsUrl() {
        // Local dev vs deployed
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
            return "ws://localhost:8000/video";
        }
        // replace with your deployed backend endpoint
        return "wss://YOUR_BACKEND_HOST/video";
    }

    function initWebSocket() {
        const url = getWsUrl();
        ws = new WebSocket(url);

        statusWs.textContent = "Backend: Connecting...";

        ws.onopen = () => {
            dotWs.classList.add("ok");
            statusWs.textContent = "Backend: Connected";
            statusModel.textContent = "Model: Active";
            dotModel.classList.add("ok");
        };

        ws.onclose = () => {
            dotWs.classList.remove("ok");
            statusWs.textContent = "Backend: Disconnected";
            dotModel.classList.remove("ok");
            statusModel.textContent = "Model: Inactive";
        };

        ws.onerror = (err) => {
            console.error("WS error:", err);
            dotWs.classList.add("err");
            statusWs.textContent = "Backend: Error";
            dotModel.classList.remove("ok");
            statusModel.textContent = "Model: Error";
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handlePrediction(data);
            } catch (e) {
                console.error("Bad message from backend:", e);
            }
        };
    }

    // ---------- FRAME SENDER ----------
    function startSendingFrames() {
        setInterval(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!aslCam.videoWidth || !aslCam.videoHeight) return;

            aslCanvas.width = aslCam.videoWidth;
            aslCanvas.height = aslCam.videoHeight;
            aslCtx.drawImage(aslCam, 0, 0);

            const frameData = aslCanvas.toDataURL("image/jpeg", 0.7);

            ws.send(JSON.stringify({
                frame: frameData,
                timestamp: Date.now()
            }));
        }, 150);
    }

    // ---------- PREDICTION HANDLING ----------
    function handlePrediction({ prediction, confidence }) {
        const confPct = Math.round(confidence * 100);

        // Update overlay
        letterEl.textContent = prediction;
        confTextEl.textContent = confPct + "%";
        confFillEl.style.width = `${confPct}%`;

        // Build word with repeated consistent predictions
        if (prediction === lastPrediction) {
            sameCount += 1;
        } else {
            lastPrediction = prediction;
            sameCount = 1;
        }

        if (sameCount >= REQUIRED_SAME) {
            addLetter(prediction);
            sameCount = 0;
        }

        // Add to history
        const now = new Date();
        const timeStr = now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        });
        history.unshift({
            prediction,
            confidence: confPct,
            time: timeStr
        });
        if (history.length > 10) history.pop();
        renderHistory();
    }

    function addLetter(letter) {
        // You can enforce only A–Z if you want here
        word += letter;
        renderWord();
    }

    function deleteLast() {
        if (!word.length) return;
        word = word.slice(0, -1);
        renderWord();
    }

    function clearWord() {
        word = "";
        renderWord();
    }

    function renderWord() {
        if (!word.length) {
            wordEl.textContent = "(empty)";
            wordEl.classList.add("empty");
        } else {
            wordEl.textContent = word;
            wordEl.classList.remove("empty");
        }
    }

    function renderHistory() {
        if (!history.length) {
            historyEl.innerHTML = `
                <div style="font-size:12px; color:#6b7280; text-align:center; padding:10px;">
                    No detections yet
                </div>`;
            return;
        }

        historyEl.innerHTML = history.map(item => `
            <div class="history-item">
                <div class="history-letter">${item.prediction}</div>
                <div class="history-meta">
                    <span class="history-conf">${item.confidence}%</span>
                    <span class="history-time">${item.time}</span>
                </div>
            </div>
        `).join("");
    }

    // ---------- UI EVENTS ----------
    document.getElementById("btn-clear").addEventListener("click", clearWord);
    document.getElementById("btn-copy").addEventListener("click", () => {
        if (!word.length) return;
        navigator.clipboard.writeText(word).catch(() => {});
    });

    document.addEventListener("keydown", (e) => {
        if (e.key === "Backspace") {
            e.preventDefault();
            deleteLast();
        } else if (e.key === "Escape") {
            e.preventDefault();
            clearWord();
        }
    });

    // ---------- INIT ----------
    window.addEventListener("load", async () => {
        initJitsi();
        await initCamera();
        initWebSocket();
        startSendingFrames();
    });
</script>
</body>
</html>