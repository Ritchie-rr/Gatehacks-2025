<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ASL + Jitsi Live Recognition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Jitsi iFrame API -->
    <script src="https://meet.jit.si/external_api.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
            background: #020617;
            color: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }
        .layout { display: grid; grid-template-columns: 2fr 1fr; height: 100vh; }
        #jitsi-container { position: relative; background: #000; }
        #meet { width: 100%; height: 100%; }

        #asl-overlay {
            position: absolute; top: 16px; right: 16px;
            background: rgba(15, 23, 42, 0.95);
            padding: 16px 20px; border-radius: 12px;
            z-index: 9999; min-width: 160px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }
        #asl-overlay-title {
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
            color: #9ca3af; margin-bottom: 8px;
        }
        #asl-letter {
            font-size: 32px; font-weight: 700; line-height: 1.2;
            background: linear-gradient(135deg, #38bdf8, #a855f7);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-align: center; min-height: 40px;
        }
        #asl-confidence {
            font-size: 13px; color: #e5e7eb; text-align: center; margin-top: 6px;
            font-weight: 500;
        }
        .confidence-bar {
            margin-top: 8px; background: #1f2937;
            border-radius: 999px; height: 6px; overflow: hidden;
        }
        .confidence-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #22c55e, #facc15);
            transition: width 0.3s ease-out;
        }

        .sidebar {
            background: #020617; border-left: 1px solid #111827;
            padding: 20px; display: flex; flex-direction: column; gap: 16px;
            overflow-y: auto;
        }
        .card { 
            background: #0f172a; 
            border: 1px solid #1f2937; 
            border-radius: 12px; 
            padding: 16px; 
        }
        .card h2 {
            font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;
            color: #9ca3af; margin-bottom: 12px; font-weight: 600;
        }

        #word-display {
            font-size: 24px; font-weight: 600; letter-spacing: 1px; 
            min-height: 60px; color: #f9fafb;
            padding: 12px;
            background: #020617;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #word-display.empty {
            font-size: 14px; letter-spacing: 0; font-style: italic; 
            color: #6b7280; font-weight: 400;
        }

        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        .btn {
            flex: 1; padding: 10px 14px; border-radius: 8px;
            background: #1e293b; border: 1px solid #334155;
            color: #e5e7eb; cursor: pointer; font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn:hover:not(:disabled) { 
            background: #334155; 
            border-color: #475569;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }
        .btn-recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .history-list { max-height: 240px; overflow-y: auto; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; border-radius: 8px; font-size: 13px;
            background: #020617; border: 1px solid #1f2937; 
            margin-bottom: 6px;
        }
        .history-letter { 
            font-size: 16px; font-weight: 600; 
            color: #38bdf8; 
            flex: 1;
        }
        .history-meta {
            text-align: right;
            font-size: 11px;
            color: #9ca3af;
        }
        .history-conf {
            font-weight: 600;
            color: #22c55e;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
            color: #d1d5db;
        }
        .dot { 
            width: 8px; height: 8px; 
            border-radius: 50%; 
            background: #4b5563; 
            flex-shrink: 0;
        }
        .dot.ok { background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
        .dot.err { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }

        #recording-status {
            text-align: center;
            padding: 8px;
            margin-top: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: #1e293b;
            color: #94a3b8;
            display: none;
        }
        #recording-status.active {
            display: block;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: #93c5fd;
            line-height: 1.5;
        }
        .info-box strong {
            color: #60a5fa;
        }
    </style>
</head>

<body>
<div class="layout">
    <div id="jitsi-container">
        <div id="meet"></div>

        <div id="asl-overlay">
            <div id="asl-overlay-title">ASL CAPTION</div>
            <div id="asl-letter">Ready</div>
            <div id="asl-confidence">-</div>
            <div class="confidence-bar"><div class="confidence-fill" id="conf-fill"></div></div>
        </div>

        <video id="asl-cam" autoplay playsinline muted style="display:none;"></video>
        <canvas id="asl-canvas" style="display:none;"></canvas>
    </div>

    <div class="sidebar">
        <div class="card">
            <h2>Sign to Translate</h2>
            
            <div class="info-box">
                <strong>How it works:</strong><br>
                â€¢ Click "Record Sign" below<br>
                â€¢ Perform your ASL gesture for 2 seconds<br>
                â€¢ The caption will appear on the other person's screen<br>
                â€¢ Must be 80%+ confident to show
            </div>

            <div id="recording-status">Recording: <span id="recording-timer">0.0</span>s</div>

            <div class="btn-row">
                <button class="btn btn-primary" id="btn-record">ðŸŽ¥ Record Sign (2s)</button>
            </div>
        </div>

        <div class="card">
            <h2>Last Translation</h2>
            <div id="word-display" class="empty">Not yet translated</div>

            <div class="btn-row">
                <button class="btn" id="btn-clear">Clear</button>
                <button class="btn" id="btn-copy">Copy Text</button>
            </div>
        </div>

        <div class="card">
            <h2>Recent Translations</h2>
            <div id="history-list" class="history-list">
                <div style="font-size:12px;color:#6b7280;text-align:center;padding:16px;">
                    No translations yet
                </div>
            </div>
        </div>

        <div class="card">
            <h2>System Status</h2>
            <div class="status-item">
                <div class="dot" id="dot-camera"></div>
                <span id="status-camera">Camera: Initializing...</span>
            </div>
            <div class="status-item">
                <div class="dot" id="dot-ws"></div>
                <span id="status-ws">Backend: Connecting...</span>
            </div>
            <div class="status-item">
                <div class="dot" id="dot-model"></div>
                <span id="status-model">Model: Waiting...</span>
            </div>
        </div>
    </div>
</div>

<script>
    let ws = null;
    let jitsiApi = null;
    let word = "";
    let history = [];
    let awaitingPrediction = false;
    let isRecording = false;

    const aslCam = document.getElementById("asl-cam");
    const aslCanvas = document.getElementById("asl-canvas");
    const aslCtx = aslCanvas.getContext("2d");

    const letterEl = document.getElementById("asl-letter");
    const confTextEl = document.getElementById("asl-confidence");
    const confFillEl = document.getElementById("conf-fill");
    const wordEl = document.getElementById("word-display");
    const historyEl = document.getElementById("history-list");

    const dotCamera = document.getElementById("dot-camera");
    const dotWs = document.getElementById("dot-ws");
    const dotModel = document.getElementById("dot-model");
    const statusCamera = document.getElementById("status-camera");
    const statusWs = document.getElementById("status-ws");
    const statusModel = document.getElementById("status-model");

    const btnRecord = document.getElementById("btn-record");
    const recordingStatus = document.getElementById("recording-status");
    const recordingTimer = document.getElementById("recording-timer");

    // ---------- Jitsi ----------
    function initJitsi() {
        try {
            jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: "ASLRoomDemo2025_" + Math.random().toString(36).substr(2, 9),
                parentNode: document.querySelector('#meet'),
                width: "100%", 
                height: "100%",
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                },
                interfaceConfigOverwrite: { 
                    SHOW_JITSI_WATERMARK: false,
                    DISPLAY_WELCOME_PAGE_CONTENT: false,
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'closedcaptions', 'desktop', 
                        'fullscreen', 'fodeviceselection', 'hangup', 
                        'chat', 'settings', 'videoquality', 'filmstrip',
                        'tileview', 'mute-everyone'
                    ],
                }
            });

            console.log("Jitsi initialized");
        } catch (err) {
            console.error("Jitsi initialization error:", err);
        }
    }

    // ---------- Camera ----------
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    facingMode: "user"
                },
                audio: false
            });
            aslCam.srcObject = stream;
            
            await new Promise((resolve) => {
                aslCam.onloadedmetadata = () => {
                    aslCam.play();
                    resolve();
                };
            });
            
            dotCamera.classList.add("ok");
            statusCamera.textContent = "Camera: Ready";
            console.log("Camera initialized successfully");
        } catch (err) {
            dotCamera.classList.add("err");
            statusCamera.textContent = "Camera: Error - " + err.message;
            console.error("Camera error:", err);
            alert("Camera access denied. Please allow camera access and refresh.");
        }
    }

    // ---------- WebSocket ----------
    function initWebSocket() {
        const wsUrl = "ws://localhost:8000/video";
        
        try {
            ws = new WebSocket(wsUrl);
        } catch (err) {
            console.error("WebSocket creation error:", err);
            updateWSStatus("error", "Failed to create WebSocket");
            return;
        }

        ws.onopen = () => {
            console.log("WebSocket connected");
            updateWSStatus("connected");
        };

        ws.onclose = (event) => {
            console.log("WebSocket closed:", event.code, event.reason);
            updateWSStatus("disconnected");
            
            setTimeout(() => {
                console.log("Attempting to reconnect...");
                initWebSocket();
            }, 3000);
        };

        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            updateWSStatus("error", "Connection error");
        };

        ws.onmessage = (event) => {
            if (!awaitingPrediction) {
                console.log("Received unexpected message:", event.data);
                return;
            }
            
            awaitingPrediction = false;
            
            try {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    console.error("Server error:", data.error);
                    handleError(data.error);
                } else if (data.prediction && data.confidence !== undefined) {
                    handlePrediction(data);
                }
            } catch (err) {
                console.error("Error parsing message:", err);
                handleError("Failed to parse server response");
            }
        };
    }

    function updateWSStatus(status, message = "") {
        dotWs.classList.remove("ok", "err");
        dotModel.classList.remove("ok", "err");
        
        if (status === "connected") {
            dotWs.classList.add("ok");
            statusWs.textContent = "Backend: Connected";
            dotModel.classList.add("ok");
            statusModel.textContent = "Model: Ready";
        } else if (status === "disconnected") {
            statusWs.textContent = "Backend: Disconnected";
            statusModel.textContent = "Model: Offline";
        } else if (status === "error") {
            dotWs.classList.add("err");
            statusWs.textContent = "Backend: " + (message || "Error");
            dotModel.classList.add("err");
            statusModel.textContent = "Model: Unavailable";
        }
    }

    // ----------------------------------------------------------
    // Recording Logic - 2 SECONDS = 60 FRAMES
    // ----------------------------------------------------------
    let frames = [];
    let recordInterval = null;
    let recordStartTime = null;

    function startRecording() {
        if (isRecording) {
            console.log("Already recording");
            return;
        }

        if (!aslCam.videoWidth || aslCam.videoWidth === 0) {
            alert("Camera not ready. Please wait and try again.");
            return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert("Backend not connected. Please wait for connection.");
            return;
        }

        console.log("Starting 2-second recording...");
        isRecording = true;
        awaitingPrediction = true;
        frames = [];
        
        // Update UI
        btnRecord.disabled = true;
        btnRecord.classList.add("btn-recording");
        btnRecord.textContent = "ðŸ”´ Recording...";
        recordingStatus.classList.add("active");
        recordStartTime = Date.now();

        // Reset overlay
        letterEl.textContent = "Recording...";
        confTextEl.textContent = "-";
        confFillEl.style.width = "0%";

        let frameCount = 0;
        const targetFrames = 60; // 2 seconds at 30fps = 60 frames
        const intervalMs = 33.33; // ~30fps (1000ms / 30fps)

        recordInterval = setInterval(() => {
            const elapsed = (Date.now() - recordStartTime) / 1000;
            recordingTimer.textContent = elapsed.toFixed(1);

            if (frameCount >= targetFrames) {
                stopRecording();
                return;
            }

            try {
                aslCanvas.width = aslCam.videoWidth;
                aslCanvas.height = aslCam.videoHeight;
                aslCtx.drawImage(aslCam, 0, 0);

                const frameData = aslCanvas.toDataURL("image/jpeg", 0.7);
                frames.push(frameData);
                frameCount++;
            } catch (err) {
                console.error("Frame capture error:", err);
            }
        }, intervalMs);
    }

    function stopRecording() {
        console.log("Stopping recording... Captured", frames.length, "frames");
        clearInterval(recordInterval);
        isRecording = false;
        
        // Update UI
        btnRecord.classList.remove("btn-recording");
        btnRecord.textContent = "ðŸŽ¥ Record Sign (2s)";
        recordingStatus.classList.remove("active");

        if (frames.length === 0) {
            console.error("No frames captured");
            awaitingPrediction = false;
            btnRecord.disabled = false;
            handleError("No frames captured");
            return;
        }

        // Send to backend
        letterEl.textContent = "Processing...";
        confTextEl.textContent = "-";
        
        try {
            const payload = JSON.stringify({ frames: frames });
            console.log("Sending", frames.length, "frames to backend");
            ws.send(payload);
        } catch (err) {
            console.error("Error sending frames:", err);
            awaitingPrediction = false;
            btnRecord.disabled = false;
            handleError("Failed to send data");
        }
    }

    btnRecord.addEventListener("click", startRecording);

    // ---------- Prediction Handling ----------
    function handlePrediction({ prediction, confidence }) {
        console.log("Received prediction:", prediction, "confidence:", confidence);
        
        const confPct = Math.round(confidence * 100);
        
        // 80% minimum confidence threshold
        const MIN_CONFIDENCE = 80;
        
        if (confPct < MIN_CONFIDENCE) {
            console.log("Confidence too low:", confPct + "%");
            
            // Update overlay with "Try Again" message
            letterEl.textContent = "Please Sign Again";
            confTextEl.textContent = confPct + "% (Too Low)";
            confFillEl.style.width = confPct + "%";
            
            // Update main display
            wordEl.textContent = "Confidence below 80% - Please sign again";
            wordEl.classList.add("empty");
            
            // Add to history with note
            const now = new Date().toLocaleTimeString();
            history.unshift({ 
                prediction: prediction + " âš ï¸ Low", 
                confidence: confPct, 
                time: now 
            });
            if (history.length > 10) history.pop();
            renderHistory();
            
            // Re-enable button
            btnRecord.disabled = false;
            return;
        }

        // Good confidence - show prediction
        letterEl.textContent = prediction;
        confTextEl.textContent = confPct + "%";
        confFillEl.style.width = confPct + "%";

        // Update main display
        word = prediction;
        renderWord();

        // Send caption to Jitsi (appears on other participant's screen)
        if (jitsiApi) {
            try {
                jitsiApi.executeCommand('sendEndpointTextMessage', '', 
                    `ASL: ${prediction} (${confPct}% confidence)`);
                console.log("Sent caption to Jitsi:", prediction);
            } catch (err) {
                console.error("Error sending caption to Jitsi:", err);
            }
        }

        // Add to history
        const now = new Date().toLocaleTimeString();
        history.unshift({ prediction, confidence: confPct, time: now });
        if (history.length > 10) history.pop();
        renderHistory();

        // Re-enable button
        btnRecord.disabled = false;
    }

    function handleError(message) {
        letterEl.textContent = "Error";
        confTextEl.textContent = "-";
        wordEl.textContent = message + " - Please try again";
        wordEl.classList.add("empty");
        btnRecord.disabled = false;
    }

    function renderWord() {
        if (!word || word.length === 0) {
            wordEl.textContent = "Not yet translated";
            wordEl.classList.add("empty");
        } else {
            wordEl.textContent = word;
            wordEl.classList.remove("empty");
        }
    }

    function renderHistory() {
        if (!history || history.length === 0) {
            historyEl.innerHTML = `
                <div style="font-size:12px;color:#6b7280;text-align:center;padding:16px;">
                    No translations yet
                </div>`;
            return;
        }
        
        historyEl.innerHTML = history.map(h => `
            <div class="history-item">
                <div class="history-letter">${h.prediction}</div>
                <div class="history-meta">
                    <div class="history-conf">${h.confidence}%</div>
                    <div class="history-time" style="margin-top:2px;">${h.time}</div>
                </div>
            </div>
        `).join("");
    }

    // Buttons
    document.getElementById("btn-clear").addEventListener("click", () => { 
        word = ""; 
        renderWord(); 
        letterEl.textContent = "Ready";
        confTextEl.textContent = "-";
        confFillEl.style.width = "0%";
    });
    
    document.getElementById("btn-copy").addEventListener("click", () => {
        if (word && word.length > 0) {
            navigator.clipboard.writeText(word).then(() => {
                alert("Copied: " + word);
            }).catch(err => {
                console.error("Copy failed:", err);
            });
        } else {
            alert("Nothing to copy");
        }
    });

    // ---------- Initialize Everything ----------
    window.onload = async () => {
        console.log("Initializing application...");
        initJitsi();
        await initCamera();
        initWebSocket();
        renderWord();
        console.log("Initialization complete");
    };
</script>
</body>
</html>